<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¯¼æ¼”å·¥ä½œå° - å·¥ä¸šçº§æ”¾å°„æµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        
        /* ğŸ’¡ è¿çº¿æ ·å¼ */
        .node-line { stroke: #3b82f6; stroke-width: 1.5; fill: none; stroke-opacity: 0.15; transition: stroke-opacity 0.3s; }
        .node-line-active { stroke: #3b82f6; stroke-width: 2.5; stroke-dasharray: 6; animation: flow 1.5s linear infinite; stroke-opacity: 0.8; }
        @keyframes flow { from { stroke-dashoffset: 24; } to { stroke-dashoffset: 0; } }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        /* å›ºå®šè¡Œé«˜ï¼Œç¡®ä¿è¿çº¿è®¡ç®—ç²¾å‡† */
        .shot-row-container { height: 220px; display: flex; align-items: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [workflow, setWorkflow] = useState(null);
            const [viewMode, setViewMode] = useState('grid'); 
            const [messages, setMessages] = useState([{ role: 'ai', text: 'æˆ‘æ˜¯æ‚¨çš„ AI æŒ‡æŒ¥å®˜ã€‚å·¥ä½œæµå·²å°±ç»ªã€‚' }]);
            const [inputText, setInputText] = useState('');
            const [loading, setLoading] = useState(false);
            
            // ğŸ’¡ çŠ¶æ€åŒæ­¥å…³é”®ï¼šè®°å½•æ»šåŠ¨ä½ç½®å’Œå®¹å™¨é«˜åº¦
            const scrollRef = useRef(null);
            const [scrollTop, setScrollTop] = useState(0);
            const [containerHeight, setContainerHeight] = useState(0);

            const fetchWorkflow = async () => {
                const res = await fetch('/api/workflow');
                const data = await res.json();
                setWorkflow(data);
            };

            useEffect(() => {
                fetchWorkflow();
                const timer = setInterval(fetchWorkflow, 3000);
                return () => clearInterval(timer);
            }, []);

            // ğŸ’¡ å®æ—¶ç›‘å¬æ»šåŠ¨
            const onScroll = (e) => setScrollTop(e.target.scrollTop);

            // è·å–å®¹å™¨é«˜åº¦ç”¨äºè®¡ç®—å±…ä¸­èµ·ç‚¹
            useEffect(() => {
                if (viewMode === 'graph' && scrollRef.current) {
                    setContainerHeight(scrollRef.current.clientHeight);
                }
            }, [viewMode]);

            const sendAgentMsg = async () => {
                if (!inputText.trim()) return;
                const msg = inputText; setInputText('');
                setMessages(prev => [...prev, { role: 'user', text: msg }]);
                setLoading(true);
                await fetch('/api/agent/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: msg }) });
                setLoading(false);
                fetchWorkflow();
            };

            const updateShot = async (shotId, desc) => {
                await fetch('/api/shot/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ shot_id: shotId, description: desc })
                });
                fetchWorkflow();
            };

            const runTask = async (type, shotId = null) => {
                await fetch(`/api/run/${type}${shotId ? `?shot_id=${shotId}` : ''}`, { method: 'POST' });
            };

            if (!workflow) return <div className="h-screen flex items-center justify-center font-mono">INITIATING...</div>;

            return (
                <div className="h-screen flex flex-col p-4 gap-4 overflow-hidden">
                    {/* Header */}
                    <div className="glass rounded-2xl p-4 flex items-center justify-between border border-white/5">
                        <div className="flex items-center gap-6">
                            <h1 className="text-xl font-bold tracking-tight bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">AI CONTENT WORKSTATION</h1>
                            <div className="flex bg-slate-900 rounded-xl p-1 border border-white/10 shadow-inner">
                                <button onClick={() => setViewMode('grid')} className={`px-5 py-1.5 rounded-lg text-xs font-bold transition ${viewMode === 'grid' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500'}`}>STORYBOARD (å¯¹æ¯”)</button>
                                <button onClick={() => setViewMode('graph')} className={`px-5 py-1.5 rounded-lg text-xs font-bold transition ${viewMode === 'graph' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500'}`}>LOGIC GRAPH (æ”¾å°„)</button>
                            </div>
                        </div>
                        <button onClick={() => runTask('video_generate')} className="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded-xl text-sm font-black shadow-lg transition-all active:scale-95">RUN WORKFLOW</button>
                    </div>

                    <div className="flex flex-1 gap-4 overflow-hidden">
                        <div className="flex-1 glass rounded-[2.5rem] overflow-hidden relative border border-white/10 shadow-2xl bg-slate-950">
                            
                            {/* --- è§†å›¾ Aï¼šStoryboard å¯¹æ¯” --- */}
                            {viewMode === 'grid' && (
                                <div className="h-full overflow-y-auto p-8 custom-scrollbar">
                                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                        {workflow.shots?.map(shot => {
                                            const isSuccess = shot.status?.video_generate === 'SUCCESS';
                                            return (
                                                <div key={shot.shot_id} className="glass rounded-3xl overflow-hidden border border-white/5 p-4 bg-slate-950/20">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <span className="font-mono text-xs text-blue-400 font-bold uppercase tracking-widest">{shot.shot_id}</span>
                                                        <span className="text-[10px] text-slate-500">{shot.start_time}s - {shot.end_time}s</span>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div className="relative aspect-video rounded-xl overflow-hidden border border-white/10">
                                                            <img src={`/assets/${shot.assets?.first_frame}`} className="w-full h-full object-cover" />
                                                            <div className="absolute top-2 right-2 bg-red-500 text-[8px] px-1.5 py-0.5 font-black rounded text-white">SOURCE</div>
                                                        </div>
                                                        <div className={`relative aspect-video rounded-xl overflow-hidden border ${isSuccess ? 'border-emerald-500/40' : 'border-blue-500/20'}`}>
                                                            {isSuccess && shot.assets?.video ? (
                                                                <video src={`/assets/${shot.assets.video}?t=${Date.now()}`} className="w-full h-full object-cover" controls autoPlay muted loop />
                                                            ) : (
                                                                <div className="flex h-full items-center justify-center bg-slate-900 font-mono text-[9px] text-blue-400 tracking-widest animate-pulse">{shot.status?.video_generate}</div>
                                                            )}
                                                            <div className="absolute top-2 right-2 bg-blue-500 text-[8px] px-1.5 py-0.5 font-black rounded text-white uppercase tracking-tighter">AI OUTPUT</div>
                                                        </div>
                                                    </div>
                                                    <div className="mt-4 p-3 bg-slate-900/50 rounded-2xl border border-white/5">
                                                        <textarea className="w-full bg-transparent border-none text-xs text-slate-300 outline-none h-14 resize-none leading-relaxed italic" defaultValue={shot.description} onBlur={(e) => updateShot(shot.shot_id, e.target.value)} />
                                                        <div className="flex justify-end mt-2"><button onClick={() => runTask('video_generate', shot.shot_id)} className="text-[9px] text-emerald-400 font-bold uppercase tracking-widest hover:text-emerald-300 transition-colors">Re-Generate</button></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* --- è§†å›¾ Bï¼šçœŸæ­£çš„æ”¾å°„æµå›¾ (å›ºå®šèµ·ç‚¹ + åŠ¨æ€è¿çº¿) --- */}
                            {viewMode === 'graph' && (
                                <div className="h-full flex relative overflow-hidden">
                                    
                                    {/* ğŸ’¡ 1. é™æ€èƒŒæ™¯è¿çº¿å±‚ (å›ºå®šåœ¨åº•å±‚) */}
                                    <svg className="absolute inset-0 w-full h-full pointer-events-none z-10">
                                        {workflow.shots?.map((shot, i) => {
                                            // è¿çº¿èµ·ç‚¹ï¼šå·¦ä¾§å®¹å™¨å®½ 350pxï¼ŒMaster Source åœ¨å…¶å‚ç›´ä¸­å¿ƒ
                                            const startX = 330; 
                                            const startY = containerHeight / 2;
                                            
                                            // è¿çº¿ç»ˆç‚¹ï¼šå³ä¾§åˆ†é•œåˆ—è¡¨çš„æ¯ä¸ª Shot çš„å·¦è¾¹ç¼˜ä¸­å¿ƒ
                                            // ç®—æ³•ï¼šåˆå§‹åç§» 40px + ç´¢å¼• i * è¡Œé«˜ 220px + è¡Œé«˜ä¸€åŠ 110px - æ»šåŠ¨ä½ç§»
                                            const endX = 420;
                                            const endY = (40 + i * 220 + 110) - scrollTop;
                                            
                                            // å¦‚æœç»ˆç‚¹è¶…å‡ºäº†å¯è§èŒƒå›´ï¼Œæ·¡åŒ–è¿çº¿
                                            const opacity = (endY < -50 || endY > containerHeight + 50) ? 0 : 1;

                                            return (
                                                <path key={i} 
                                                    d={`M ${startX} ${startY} C ${startX + 40} ${startY}, ${endX - 40} ${endY}, ${endX} ${endY}`} 
                                                    className={`node-line ${shot.status?.video_generate === 'RUNNING' || loading ? 'node-line-active' : ''}`}
                                                    style={{ strokeOpacity: opacity * (shot.status?.video_generate === 'SUCCESS' ? 0.6 : 0.15) }}
                                                />
                                            );
                                        })}
                                    </svg>

                                    {/* ğŸ’¡ 2. å·¦ä¾§å›ºå®šé¢æ¿ (ä¸æ»šåŠ¨) */}
                                    <div className="w-[350px] flex-shrink-0 flex items-center justify-center p-8 z-20 border-r border-white/5 relative bg-slate-950">
                                        <div className="glass p-6 rounded-[2.5rem] border-2 border-red-500/40 w-full shadow-[0_0_50px_rgba(239,68,68,0.15)] relative">
                                            {/* ç‰©ç†å‘å°„å­” */}
                                            <div className="absolute -right-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-red-500 rounded-full shadow-[0_0_15px_#ef4444]"></div>
                                            
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                                <h3 className="text-xs font-black tracking-widest uppercase text-red-500">Master Source</h3>
                                            </div>
                                            <div className="aspect-video bg-black rounded-2xl overflow-hidden mb-4 border border-white/10 flex items-center justify-center font-mono text-[10px] text-slate-500 italic text-center px-4">
                                                {workflow.source_video}
                                            </div>
                                            <div className="bg-white/5 p-3 rounded-xl border border-white/5">
                                                <p className="text-[9px] text-slate-500 uppercase font-black mb-1 tracking-widest">Decomposition Node</p>
                                                <p className="text-[10px] text-emerald-400 font-mono italic leading-tight">Segmenting input into {workflow.shots?.length} parallel tasks...</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* ğŸ’¡ 3. å³ä¾§æ»šåŠ¨åˆ—è¡¨ */}
                                    <div 
                                        className="flex-1 overflow-y-auto relative custom-scrollbar z-20" 
                                        onScroll={onScroll}
                                        ref={scrollRef}
                                    >
                                        <div className="py-10 pl-20 pr-10 space-y-0">
                                            {workflow.shots?.map((shot, i) => {
                                                const isSuccess = shot.status?.video_generate === 'SUCCESS';
                                                const isRunning = shot.status?.video_generate === 'RUNNING';
                                                return (
                                                    <div key={shot.shot_id} className="shot-row-container gap-6">
                                                        {/* è¾“å…¥å±‚ */}
                                                        <div className="w-56 glass p-3 rounded-2xl border border-white/10 text-[9px] relative transition-all duration-500 group">
                                                            {/* è¿çº¿æ¥æ”¶å­” */}
                                                            <div className="absolute -left-1.5 top-1/2 -translate-y-1/2 w-2.5 h-2.5 bg-blue-500 rounded-full shadow-[0_0_10px_#3b82f6]"></div>
                                                            <div className="text-blue-400 font-black tracking-widest uppercase mb-2">Input: Shot #{i+1}</div>
                                                            <div className="flex gap-2">
                                                                <img src={`/assets/${shot.assets?.first_frame}`} className="w-12 h-12 rounded-lg object-cover border border-white/10 shadow-lg" />
                                                                <div className="overflow-hidden">
                                                                    <p className="text-slate-400 font-mono truncate">{workflow.global?.style_prompt}</p>
                                                                    <p className="text-slate-500 italic truncate mt-1">"{shot.description}"</p>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div className="text-slate-700 font-bold opacity-30 italic">âœ</div>

                                                        {/* å¤„ç†å¼•æ“ */}
                                                        <div className={`w-40 glass p-3 rounded-2xl border-2 flex flex-col items-center justify-center gap-1 transition-all duration-700 ${isRunning ? 'border-blue-500 bg-blue-500/10 scale-105' : isSuccess ? 'border-emerald-500/50' : 'border-white/10 opacity-40'}`}>
                                                            <span className="text-[8px] text-slate-500 uppercase font-black tracking-tighter">AI Processor</span>
                                                            <span className="text-[11px] font-bold font-mono">Veo 3.1</span>
                                                            <span className={`text-[7px] px-2 py-0.5 rounded-full font-bold uppercase tracking-widest ${isSuccess ? 'bg-emerald-500/20 text-emerald-400' : isRunning ? 'bg-blue-500/20 text-blue-400 animate-pulse' : 'bg-slate-800 text-slate-500'}`}>
                                                                {isSuccess ? 'COMPLETED' : isRunning ? 'WORKING' : 'WAITING'}
                                                            </span>
                                                        </div>

                                                        <div className="text-slate-700 font-bold opacity-30 italic">âœ</div>

                                                        {/* è¾“å‡ºèµ„æº */}
                                                        <div className={`w-64 glass p-2 rounded-2xl border transition-all duration-700 ${isSuccess ? 'border-emerald-500/40 bg-emerald-500/5 shadow-2xl scale-105' : 'border-white/5 opacity-40'}`}>
                                                            <div className="aspect-video bg-black rounded-xl overflow-hidden relative shadow-inner">
                                                                {isSuccess && shot.assets.video ? (
                                                                    <video src={`/assets/${shot.assets.video}`} className="w-full h-full object-cover" autoPlay muted loop />
                                                                ) : (
                                                                    <div className="h-full flex items-center justify-center text-[8px] text-slate-700 italic font-mono uppercase tracking-widest">asset_pending.mp4</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* å³ä¾§ Agent äº¤äº’ */}
                        <div className="w-80 flex flex-col glass rounded-[2.5rem] overflow-hidden border border-white/10 shadow-2xl">
                            <div className="p-5 border-b border-white/5 bg-white/5 flex items-center gap-3">
                                <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_10px_#10b981]"></div>
                                <span className="text-xs font-black tracking-widest uppercase text-emerald-400 tracking-tighter">Director Agent</span>
                            </div>
                            <div className="flex-1 overflow-y-auto p-5 space-y-5 custom-scrollbar bg-slate-950/20 text-xs">
                                {messages.map((m, i) => (
                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[90%] p-3.5 rounded-2xl shadow-sm leading-relaxed ${m.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none border border-white/5'}`}>
                                            {m.text}
                                        </div>
                                    </div>
                                ))}
                                {loading && <div className="text-[10px] text-slate-500 font-mono animate-pulse text-center uppercase tracking-widest mt-2">Updating Neural Graph...</div>}
                            </div>
                            <div className="p-5 bg-slate-900/80 border-t border-white/10">
                                <div className="flex gap-2">
                                    <input value={inputText} onChange={e => setInputText(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendAgentMsg()} placeholder="Command Agent..." className="flex-1 bg-slate-950 border border-white/10 rounded-xl px-4 py-2.5 text-xs outline-none focus:border-blue-500 text-white transition-all shadow-inner" />
                                    <button onClick={sendAgentMsg} className="bg-blue-600 hover:bg-blue-500 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95 shadow-lg shadow-blue-900/30">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>