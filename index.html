<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 导演工作台 - 逻辑拆解版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .node-line { stroke: #334155; stroke-width: 2; fill: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [workflow, setWorkflow] = useState(null);
            const [viewMode, setViewMode] = useState('grid'); 
            const [messages, setMessages] = useState([{ role: 'ai', text: '我是您的 AI 指挥官。工作流逻辑已就绪，等待指令。' }]);
            const [inputText, setInputText] = useState('');
            const [loading, setLoading] = useState(false);

            const fetchWorkflow = async () => {
                const res = await fetch('/api/workflow');
                const data = await res.json();
                setWorkflow(data);
            };

            useEffect(() => {
                fetchWorkflow();
                const timer = setInterval(fetchWorkflow, 3000);
                return () => clearInterval(timer);
            }, []);

            const sendAgentMsg = async () => {
                if (!inputText.trim()) return;
                const msg = inputText; setInputText('');
                setMessages(prev => [...prev, { role: 'user', text: msg }]);
                setLoading(true);
                await fetch('/api/agent/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: msg }) });
                setLoading(false);
                fetchWorkflow();
            };

            const updateShot = async (shotId, desc) => {
                await fetch('/api/shot/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ shot_id: shotId, description: desc })
                });
                fetchWorkflow();
            };

            const runTask = async (type, shotId = null) => {
                await fetch(`/api/run/${type}${shotId ? `?shot_id=${shotId}` : ''}`, { method: 'POST' });
            };

            if (!workflow) return <div className="h-screen flex items-center justify-center font-mono">CONNECTING TO WORKFLOW...</div>;

            return (
                <div className="h-screen flex flex-col p-4 gap-4 overflow-hidden">
                    {/* Header */}
                    <div className="glass rounded-2xl p-4 flex items-center justify-between border border-white/5">
                        <div className="flex items-center gap-6">
                            <h1 className="text-xl font-bold tracking-tight">AI CONTENT WORKSTATION</h1>
                            <div className="flex bg-slate-900 rounded-xl p-1 border border-white/10">
                                <button onClick={() => setViewMode('grid')} className={`px-5 py-1.5 rounded-lg text-xs font-bold transition ${viewMode === 'grid' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>STORYBOARD (精修)</button>
                                <button onClick={() => setViewMode('graph')} className={`px-5 py-1.5 rounded-lg text-xs font-bold transition ${viewMode === 'graph' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>LOGIC GRAPH (工作流)</button>
                            </div>
                        </div>
                        <button onClick={() => runTask('video_generate')} className="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded-xl text-sm font-black shadow-lg">RUN ENTIRE WORKFLOW</button>
                    </div>

                    <div className="flex flex-1 gap-4 overflow-hidden">
                        <div className="flex-1 glass rounded-3xl overflow-hidden relative border border-white/10 shadow-inner">
                            
                            {/* --- 形态 3：Higgsfield 网格 --- */}
                            {viewMode === 'grid' && (
                                <div className="h-full overflow-y-auto p-8 custom-scrollbar">
                                    <div className="grid grid-cols-2 xl:grid-cols-3 gap-8">
                                        {workflow.shots?.map(shot => {
                                            const isSuccess = shot.status?.video_generate === 'SUCCESS';
                                            return (
                                                <div key={shot.shot_id} className={`glass rounded-3xl overflow-hidden border transition-all ${isSuccess ? 'border-emerald-500/40' : 'border-white/5'}`}>
                                                    <div className="aspect-video bg-black relative">
                                                        {isSuccess && shot.assets?.video ? (
                                                            <video key={shot.status?.video_generate} src={`/assets/${shot.assets.video}?t=${Date.now()}`} className="w-full h-full object-cover" controls autoPlay muted loop />
                                                        ) : (
                                                            <img src={`/assets/${shot.assets?.stylized_frame || shot.assets?.first_frame}`} className="w-full h-full object-cover opacity-50" />
                                                        )}
                                                        <div className="absolute top-4 left-4 bg-black/60 px-3 py-1 rounded-full font-mono text-[10px]">{shot.shot_id}</div>
                                                    </div>
                                                    <div className="p-5 flex flex-col gap-4">
                                                        <textarea 
                                                            className="w-full bg-slate-950/50 border border-white/5 rounded-2xl p-3 text-xs text-slate-300 outline-none h-20"
                                                            defaultValue={shot.description}
                                                            onBlur={(e) => updateShot(shot.shot_id, e.target.value)}
                                                        />
                                                        <div className="flex justify-between items-center">
                                                            <span className={`text-[10px] font-bold px-2 py-1 rounded uppercase ${isSuccess ? 'text-emerald-400 bg-emerald-400/10' : 'text-blue-400 bg-blue-400/10'}`}>{shot.status?.video_generate}</span>
                                                            <button onClick={() => runTask('video_generate', shot.shot_id)} className="text-[10px] text-slate-500 hover:text-white underline font-bold">RE-RENDER</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* --- 形态 1：Roboneo 逻辑节点视图 (重点更新) --- */}
                            {viewMode === 'graph' && (
                                <div className="h-full relative overflow-hidden bg-slate-950 p-10 overflow-y-auto custom-scrollbar">
                                    <div className="flex flex-col gap-16 relative z-10">
                                        
                                        {/* 全局输入源 */}
                                        <div className="flex justify-center">
                                            <div className="glass p-6 rounded-2xl border-2 border-blue-500/50 w-96 shadow-[0_0_20px_rgba(59,130,246,0.2)]">
                                                <div className="flex items-center gap-3 mb-3 border-b border-white/10 pb-2">
                                                    <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                                                    <h3 className="text-xs font-black tracking-widest uppercase">Global Stylesheet (Input 1)</h3>
                                                </div>
                                                <p className="text-xs font-mono text-emerald-400">"{workflow.global?.style_prompt}"</p>
                                            </div>
                                        </div>

                                        {/* 分镜逻辑处理链 */}
                                        <div className="space-y-12">
                                            {workflow.shots?.map(shot => {
                                                const isSuccess = shot.status?.video_generate === 'SUCCESS';
                                                const isRunning = shot.status?.video_generate === 'RUNNING';
                                                return (
                                                    <div key={shot.shot_id} className="flex items-center justify-center gap-8">
                                                        
                                                        {/* Step 1: Input Combine */}
                                                        <div className="w-64 glass p-4 rounded-xl border border-white/10 text-[10px]">
                                                            <div className="text-slate-500 uppercase mb-2 font-bold tracking-tighter">Combine Inputs</div>
                                                            <div className="bg-black/40 p-2 rounded mb-2 border border-white/5 truncate">G-Style: {workflow.global?.style_prompt}</div>
                                                            <div className="bg-black/40 p-2 rounded border border-white/5 italic">S-Prompt: "{shot.description}"</div>
                                                        </div>

                                                        {/* Arrow */}
                                                        <div className="text-slate-700">➜</div>

                                                        {/* Step 2: AI Processor */}
                                                        <div className={`w-48 glass p-4 rounded-xl border-2 flex flex-col items-center gap-2 ${isRunning ? 'border-blue-500 bg-blue-500/10 animate-pulse' : 'border-white/20'}`}>
                                                            <div className="text-[10px] font-black uppercase text-slate-400">Processor</div>
                                                            <div className="font-mono text-xs font-bold">Google Veo 3.1</div>
                                                            <div className={`text-[8px] px-2 py-0.5 rounded ${isSuccess ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-800 text-slate-400'}`}>
                                                                {isSuccess ? 'COMPLETED' : isRunning ? 'RENDERING...' : 'READY'}
                                                            </div>
                                                        </div>

                                                        {/* Arrow */}
                                                        <div className="text-slate-700">➜</div>

                                                        {/* Step 3: Output */}
                                                        <div className={`w-56 glass p-2 rounded-xl border ${isSuccess ? 'border-emerald-500/50' : 'border-white/5'}`}>
                                                            <div className="text-[9px] text-slate-500 uppercase mb-1 font-bold">Output Asset</div>
                                                            <div className="aspect-video bg-black rounded-lg overflow-hidden relative border border-white/10">
                                                                {isSuccess ? (
                                                                    <video src={`/assets/${shot.assets.video}`} className="w-full h-full object-cover" autoPlay muted loop />
                                                                ) : (
                                                                    <div className="flex h-full items-center justify-center text-[8px] text-slate-600 font-mono italic px-4 text-center">
                                                                        {shot.shot_id}.mp4 pending...
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* 右侧 Agent */}
                        <div className="w-80 flex flex-col glass rounded-3xl overflow-hidden border border-white/10 shadow-2xl">
                            <div className="p-4 border-b border-white/10 bg-white/5 flex items-center justify-between">
                                <span className="text-xs font-bold uppercase tracking-widest text-emerald-400">Agent Command Center</span>
                                <span className="text-[10px] font-mono text-slate-500">v2.1</span>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-slate-950/20">
                                {messages.map((m, i) => (
                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[90%] p-3 rounded-2xl text-xs leading-relaxed ${m.role === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-200'}`}>
                                            {m.text}
                                        </div>
                                    </div>
                                ))}
                                {loading && <div className="text-[10px] text-slate-500 animate-pulse text-center font-mono">RE-COMPOSING WORKFLOW...</div>}
                            </div>
                            <div className="p-4 bg-slate-900/80 border-t border-white/10">
                                <div className="flex gap-2">
                                    <input value={inputText} onChange={e => setInputText(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendAgentMsg()} placeholder="输入全局修改指令..." className="flex-1 bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-xs focus:border-blue-500 outline-none text-white" />
                                    <button onClick={sendAgentMsg} className="bg-blue-600 px-4 py-2 rounded-xl text-xs font-bold">SEND</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>